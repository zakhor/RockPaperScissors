<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Åò„ÇÉ„Çì„Åë„Çì„Ç≤„Éº„É† - AIÂØæÊà¶</title>
    <script src="lib/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #C0C0C0;
            padding: 20px;
            color: #000000;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border: 2px solid black;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #000000;
            margin-bottom: 5px;
            font-size: 2em;
            border-bottom: 2px solid black;
            padding-bottom: 10px;
        }

        .game-area {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .ai-avatar {
            width: 200px;
            height: 200px;
            background: #F0F0F0;
            border: 2px solid #808080;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
        }

        .score-board {
            background: #F0F0F0;
            padding: 15px;
            border: 2px solid #808080;
            text-align: center;
        }

        .score-board h2 {
            margin-bottom: 15px;
            color: #000000;
            font-size: 1.2em;
            background: #808080;
            color: white;
            padding: 5px;
            border: 1px solid black;
        }

        .scores {
            display: flex;
            justify-content: space-around;
            font-size: 1.2em;
        }

        .score-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .score-label {
            color: #000000;
            font-size: 0.9em;
            font-weight: bold;
        }

        .score-value {
            font-weight: bold;
            font-size: 1.5em;
            font-family: 'Courier New', monospace;
        }

        .score-value.ai { color: #FF0000; }
        .score-value.user { color: #0000FF; }
        .score-value.draw { color: #808080; }

        .buttons-section {
            background: #F0F0F0;
            padding: 15px;
            border: 2px solid #808080;
        }

        .buttons-section h3 {
            margin-bottom: 10px;
            text-align: center;
            color: white;
            font-size: 1.1em;
            background: #808080;
            padding: 5px;
            border: 1px solid black;
        }

        .buttons {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }

        .hand-button {
            flex: 1;
            padding: 20px;
            font-size: 3em;
            border: 2px outset #808080;
            background: #C0C0C0;
            cursor: pointer;
            font-weight: bold;
        }

        .hand-button:hover:not(:disabled) {
            background: #D0D0D0;
        }

        .hand-button:active:not(:disabled) {
            border-style: inset;
        }

        .hand-button:disabled {
            background: #F0F0F0;
            cursor: not-allowed;
            color: #808080;
        }

        .hand-button.selected {
            border: 2px inset #808080;
            background: #FFFF00;
        }

        .history-section {
            background: #F0F0F0;
            padding: 15px;
            border: 2px solid #808080;
        }

        .history-section h3 {
            margin-bottom: 10px;
            color: white;
            font-size: 1.1em;
            background: #808080;
            padding: 5px;
            border: 1px solid black;
        }

        .history-table-container {
            max-height: 300px;
            overflow-y: scroll;
            border: 2px solid black;
            background: white;
        }

        .history-table-container::-webkit-scrollbar {
            width: 16px;
            background: #F0F0F0;
            border-left: 2px solid black;
        }

        .history-table-container::-webkit-scrollbar-thumb {
            background: #C0C0C0;
            border: 2px solid #808080;
        }

        .history-table-container::-webkit-scrollbar-thumb:hover {
            background: #A0A0A0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: #808080;
            color: white;
            padding: 8px;
            text-align: center;
            border: 1px solid black;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        td {
            padding: 8px;
            text-align: center;
            border: 1px solid black;
        }

        tr:nth-child(even) {
            background: #F0F0F0;
        }

        .result-win { color: #0000FF; font-weight: bold; }
        .result-lose { color: #FF0000; font-weight: bold; }
        .result-draw { color: #808080; font-weight: bold; }

        .chart-section {
            background: #F0F0F0;
            padding: 15px;
            border: 2px solid #808080;
        }

        .chart-section h3 {
            margin-bottom: 10px;
            color: white;
            font-size: 1.1em;
            background: #808080;
            padding: 5px;
            border: 1px solid black;
        }

        #gameChart {
            max-height: 300px;
            background: white;
            border: 2px solid black;
            padding: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border: 2px solid black;
            text-align: center;
            max-width: 500px;
        }

        .modal-content h2 {
            font-size: 2em;
            margin-bottom: 15px;
            color: #000000;
        }

        .modal-content p {
            font-size: 1.2em;
            margin-bottom: 25px;
            color: #000000;
        }

        .reset-button {
            padding: 12px 30px;
            font-size: 1.1em;
            background: #C0C0C0;
            color: #000000;
            border: 2px outset #808080;
            cursor: pointer;
            font-weight: bold;
        }

        .reset-button:hover {
            background: #D0D0D0;
        }

        .reset-button:active {
            border-style: inset;
        }

        @media (max-width: 900px) {
            .game-area {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>„Åò„ÇÉ„Çì„Åë„Çì„Éû„É≥„Å´Âãù„Å¶„Çã„Åã„Å™Ôºü</h1>
        <p style="text-align: center; margin-bottom: 15px; font-weight: bold;">30Êú¨ÂÖàÂèñÂãùË≤†</p>

        <div class="game-area">
            <!-- Left Panel -->
            <div class="left-panel">
                <!-- AI Avatar -->
                <div class="ai-avatar" id="aiAvatar">üòÄ</div>

                <!-- Score Board -->
                <div class="score-board">
                    <h2>„Çπ„Ç≥„Ç¢</h2>
                    <div class="scores">
                        <div class="score-item">
                            <span class="score-label">AI</span>
                            <span class="score-value ai" id="aiWins">0</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">„ÅÇ„Å™„Åü</span>
                            <span class="score-value user" id="userWins">0</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">„ÅÇ„ÅÑ„Åì</span>
                            <span class="score-value draw" id="draws">0</span>
                        </div>
                    </div>
                </div>

                <!-- AI Buttons -->
                <div class="buttons-section">
                    <h3>AI„ÅÆÊâã</h3>
                    <div class="buttons">
                        <button class="hand-button" id="aiRock" disabled>‚úä</button>
                        <button class="hand-button" id="aiPaper" disabled>‚úã</button>
                        <button class="hand-button" id="aiScissors" disabled>‚úåÔ∏è</button>
                    </div>
                </div>

                <!-- User Buttons -->
                <div class="buttons-section">
                    <h3>„ÅÇ„Å™„Åü„ÅÆÊâã</h3>
                    <div class="buttons">
                        <button class="hand-button" id="userRock" onclick="playRound('ROCK')">‚úä</button>
                        <button class="hand-button" id="userPaper" onclick="playRound('PAPER')">‚úã</button>
                        <button class="hand-button" id="userScissors" onclick="playRound('SCISSORS')">‚úåÔ∏è</button>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <!-- Chart -->
                <div class="chart-section">
                    <h3>Á¥ØÁ©ç„Ç∞„É©„ÉïÔºàÁõ¥Ëøë10ÂõûÔºâ</h3>
                    <canvas id="gameChart"></canvas>
                </div>

                <!-- History Table -->
                <div class="history-section">
                    <h3>ÂØæÊà¶Â±•Ê≠¥ÔºàÁõ¥Ëøë10‰ª∂Ôºâ</h3>
                    <div class="history-table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ÂõûÊï∞</th>
                                    <th>AI„ÅÆÊâã</th>
                                    <th>„ÅÇ„Å™„Åü„ÅÆÊâã</th>
                                    <th>ÂãùÊïó</th>
                                </tr>
                            </thead>
                            <tbody id="historyTable">
                                <tr><td colspan="4">„Åæ„Å†ÂØæÊà¶Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game End Modal -->
    <div class="modal" id="gameEndModal">
        <div class="modal-content">
            <h2 id="modalTitle">„Ç≤„Éº„É†ÁµÇ‰∫Ü</h2>
            <p id="modalMessage"></p>
            <button class="reset-button" onclick="resetGame()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éó„É¨„Ç§</button>
        </div>
    </div>

    <script>
        // Game State
        const HANDS = {
            ROCK: 'ROCK',
            PAPER: 'PAPER',
            SCISSORS: 'SCISSORS'
        };

        const HAND_SYMBOLS = {
            ROCK: '‚úä',
            PAPER: '‚úã',
            SCISSORS: '‚úåÔ∏è'
        };

        const HAND_NAMES = {
            ROCK: '„Ç∞„Éº',
            PAPER: '„Éë„Éº',
            SCISSORS: '„ÉÅ„Éß„Ç≠'
        };

        let gameState = {
            round: 0,
            aiWins: 0,
            userWins: 0,
            draws: 0,
            history: [], // { round, aiHand, userHand, result }
            userHandHistory: [], // For pattern prediction
            aiHandHistory: [], // AI's hand history
            historyDependency: {}, // For history-dependent prediction
            ngramTable: {}, // For pattern prediction
            nextAIHand: null // Pre-calculated next AI hand
        };

        let chart = null;

        // Initialize game
        function initGame() {
            initChart();
            initHistoryDependency();
            prepareNextAIHand(); // Calculate first AI hand
        }

        function initHistoryDependency() {
            const hands = ['R', 'P', 'S'];
            for (let ai of hands) {
                for (let user of hands) {
                    const key = `${ai}_${user}`;
                    gameState.historyDependency[key] = { ROCK: 0, PAPER: 0, SCISSORS: 0 };
                }
            }
        }

        function initChart() {
            const ctx = document.getElementById('gameChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '„ÅÇ„Å™„Åü„ÅÆÂãù„Å°',
                            data: [],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: '„ÅÇ„Å™„Åü„ÅÆË≤†„Åë',
                            data: [],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: '„ÅÇ„ÅÑ„Åì',
                            data: [],
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    devicePixelRatio: window.devicePixelRatio || 2,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14
                                }
                            }
                        }
                    }
                }
            });
        }

        // Main game logic
        function playRound(userHand) {
            gameState.round++;

            // Use pre-calculated AI hand
            const aiHand = gameState.nextAIHand;

            // Determine result
            const result = determineWinner(aiHand, userHand);

            // Update scores
            if (result === 'AI_WIN') {
                gameState.aiWins++;
            } else if (result === 'USER_WIN') {
                gameState.userWins++;
            } else {
                gameState.draws++;
            }

            // Add to history
            gameState.history.push({
                round: gameState.round,
                aiHand: aiHand,
                userHand: userHand,
                result: result
            });

            // Learn from this round
            learnFromRound(aiHand, userHand);

            // Update UI
            updateScores();
            updateButtons(aiHand, userHand);
            updateAIAvatar(result);
            updateHistoryTable();
            updateChart();

            // Check for game end
            if (gameState.aiWins >= 30 || gameState.userWins >= 30) {
                setTimeout(() => showGameEndModal(), 500);
            } else {
                // Prepare next AI hand for next round
                prepareNextAIHand();
            }
        }

        function prepareNextAIHand() {
            // First round: random
            if (gameState.round === 0) {
                gameState.nextAIHand = randomHand();
                return;
            }

            // Get predictions
            const historyPrediction = predictByHistory();
            const patternPrediction = predictByPattern();

            // Decide strategy
            if (historyPrediction === null && patternPrediction === null) {
                gameState.nextAIHand = randomHand();
            } else if (historyPrediction === patternPrediction && historyPrediction !== null) {
                // Both agree: play winning hand
                gameState.nextAIHand = getWinningHand(historyPrediction);
            } else {
                // Disagreement: play non-losing hand
                gameState.nextAIHand = getNonLosingHand(historyPrediction, patternPrediction);
            }
        }

        function predictByHistory() {
            if (gameState.history.length === 0) {
                return null;
            }

            const lastRound = gameState.history[gameState.history.length - 1];
            const lastAI = handToShort(lastRound.aiHand);
            const lastUser = handToShort(lastRound.userHand);
            const key = `${lastAI}_${lastUser}`;

            const counts = gameState.historyDependency[key];
            if (!counts) {
                return null;
            }

            return findMaxHand(counts);
        }

        function predictByPattern() {
            const votes = { ROCK: 0, PAPER: 0, SCISSORS: 0 };

            // Check 0-gram (no context) first
            const zeroGramKey = '0:';
            const zeroGramHands = gameState.ngramTable[zeroGramKey];
            if (zeroGramHands) {
                const maxHand = findMaxHand(zeroGramHands);
                if (maxHand) {
                    const hitCount = zeroGramHands[maxHand];
                    const voteWeight = hitCount * 0.5;  // 0-gram gets half weight
                    votes[maxHand] += voteWeight;
                }
            }

            // Regular n-gram patterns (1 to 5)
            if (gameState.userHandHistory.length > 0) {
                for (let patternLen = 1; patternLen <= 5; patternLen++) {
                    if (gameState.userHandHistory.length < patternLen) continue;

                    const pattern = gameState.userHandHistory.slice(-patternLen);
                    const key = `${patternLen}:${pattern.join(',')}`;
                    const nextHands = gameState.ngramTable[key];

                    if (!nextHands) continue;

                    const maxHand = findMaxHand(nextHands);
                    if (!maxHand) continue;

                    const hitCount = nextHands[maxHand];
                    const voteWeight = hitCount * patternLen;
                    votes[maxHand] += voteWeight;
                }
            }

            return findMaxHand(votes);
        }

        function learnFromRound(aiHand, userHand) {
            // Add to user hand history
            gameState.userHandHistory.push(userHand);
            gameState.aiHandHistory.push(aiHand);

            // Update ngram table
            const histLen = gameState.userHandHistory.length;

            // Special case: first hand (no prior context)
            if (histLen === 1) {
                const key = '0:';  // 0-gram: no context
                if (!gameState.ngramTable[key]) {
                    gameState.ngramTable[key] = { ROCK: 0, PAPER: 0, SCISSORS: 0 };
                }
                gameState.ngramTable[key][userHand]++;
            }

            // Regular n-gram learning (for 2nd hand onwards)
            if (histLen >= 2) {
                for (let patternLen = 1; patternLen <= 5; patternLen++) {
                    if (histLen <= patternLen) continue;

                    const pattern = gameState.userHandHistory.slice(histLen - patternLen - 1, histLen - 1);
                    const nextHand = gameState.userHandHistory[histLen - 1];
                    const key = `${patternLen}:${pattern.join(',')}`;

                    if (!gameState.ngramTable[key]) {
                        gameState.ngramTable[key] = { ROCK: 0, PAPER: 0, SCISSORS: 0 };
                    }
                    gameState.ngramTable[key][nextHand]++;
                }
            }

            // Update history dependency
            if (gameState.history.length >= 2) {
                const prevRound = gameState.history[gameState.history.length - 2];
                const prevAI = handToShort(prevRound.aiHand);
                const prevUser = handToShort(prevRound.userHand);
                const key = `${prevAI}_${prevUser}`;

                if (gameState.historyDependency[key]) {
                    gameState.historyDependency[key][userHand]++;
                }
            }
        }

        function determineWinner(aiHand, userHand) {
            if (aiHand === userHand) return 'DRAW';

            if (
                (aiHand === HANDS.ROCK && userHand === HANDS.SCISSORS) ||
                (aiHand === HANDS.PAPER && userHand === HANDS.ROCK) ||
                (aiHand === HANDS.SCISSORS && userHand === HANDS.PAPER)
            ) {
                return 'AI_WIN';
            }

            return 'USER_WIN';
        }

        function randomHand() {
            const hands = [HANDS.ROCK, HANDS.PAPER, HANDS.SCISSORS];
            return hands[Math.floor(Math.random() * hands.length)];
        }

        function getWinningHand(opponentHand) {
            if (opponentHand === HANDS.ROCK) return HANDS.PAPER;
            if (opponentHand === HANDS.PAPER) return HANDS.SCISSORS;
            if (opponentHand === HANDS.SCISSORS) return HANDS.ROCK;
            return randomHand();
        }

        function getNonLosingHand(hand1, hand2) {
            if (hand1 === null) return getWinningHand(hand2);
            if (hand2 === null) return getWinningHand(hand1);
            if (hand1 === hand2) return getWinningHand(hand1);

            const set = new Set([hand1, hand2]);
            if (set.has(HANDS.ROCK) && set.has(HANDS.PAPER)) return HANDS.PAPER;
            if (set.has(HANDS.ROCK) && set.has(HANDS.SCISSORS)) return HANDS.ROCK;
            if (set.has(HANDS.PAPER) && set.has(HANDS.SCISSORS)) return HANDS.SCISSORS;

            return randomHand();
        }

        function findMaxHand(counts) {
            if (!counts) return null;

            let maxCount = 0;
            let maxHand = null;
            let tieCount = 0;

            for (let hand in counts) {
                if (counts[hand] > maxCount) {
                    maxCount = counts[hand];
                    maxHand = hand;
                    tieCount = 1;
                } else if (counts[hand] === maxCount && counts[hand] > 0) {
                    tieCount++;
                }
            }

            if (maxCount === 0 || tieCount > 1) return null;
            return maxHand;
        }

        function handToShort(hand) {
            if (hand === HANDS.ROCK) return 'R';
            if (hand === HANDS.PAPER) return 'P';
            if (hand === HANDS.SCISSORS) return 'S';
            return '';
        }

        // UI Updates
        function updateScores() {
            document.getElementById('aiWins').textContent = gameState.aiWins;
            document.getElementById('userWins').textContent = gameState.userWins;
            document.getElementById('draws').textContent = gameState.draws;
        }

        function updateButtons(aiHand, userHand) {
            // Clear previous selections
            document.querySelectorAll('.hand-button').forEach(btn => btn.classList.remove('selected'));

            // Highlight AI hand
            if (aiHand === HANDS.ROCK) document.getElementById('aiRock').classList.add('selected');
            if (aiHand === HANDS.PAPER) document.getElementById('aiPaper').classList.add('selected');
            if (aiHand === HANDS.SCISSORS) document.getElementById('aiScissors').classList.add('selected');

            // Highlight User hand
            if (userHand === HANDS.ROCK) document.getElementById('userRock').classList.add('selected');
            if (userHand === HANDS.PAPER) document.getElementById('userPaper').classList.add('selected');
            if (userHand === HANDS.SCISSORS) document.getElementById('userScissors').classList.add('selected');
        }

        function updateAIAvatar(result) {
            const aiAvatar = document.getElementById('aiAvatar');

            if (result === 'AI_WIN') {
                const winEmojis = ['ü§≠', 'ü§©', 'üòç', 'ü•≥', 'ü•±'];
                const randomEmoji = winEmojis[Math.floor(Math.random() * winEmojis.length)];
                aiAvatar.textContent = randomEmoji; // AI wins: random happy face
            } else if (result === 'USER_WIN') {
                const loseEmojis = ['ü§¢', 'üò°', 'üò©', 'üò≠', 'ü•∫'];
                const randomEmoji = loseEmojis[Math.floor(Math.random() * loseEmojis.length)];
                aiAvatar.textContent = randomEmoji; // AI loses: random sad face
            } else {
                aiAvatar.textContent = 'üòê'; // Draw: neutral face
            }
        }

        function updateHistoryTable() {
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = '';

            // Show last 10 rounds in descending order
            const recentHistory = gameState.history.slice(-10).reverse();

            if (recentHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">„Åæ„Å†ÂØæÊà¶Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>';
                return;
            }

            recentHistory.forEach(round => {
                const row = document.createElement('tr');

                const resultText = round.result === 'USER_WIN' ? 'Âãù„Å°' :
                                  round.result === 'AI_WIN' ? 'Ë≤†„Åë' : '„ÅÇ„ÅÑ„Åì';
                const resultClass = round.result === 'USER_WIN' ? 'result-win' :
                                   round.result === 'AI_WIN' ? 'result-lose' : 'result-draw';

                row.innerHTML = `
                    <td>${round.round}</td>
                    <td>${HAND_SYMBOLS[round.aiHand]}</td>
                    <td>${HAND_SYMBOLS[round.userHand]}</td>
                    <td class="${resultClass}">${resultText}</td>
                `;

                tbody.appendChild(row);
            });
        }

        function updateChart() {
            // Get last 10 rounds
            const recentHistory = gameState.history.slice(-10);

            const labels = recentHistory.map(r => r.round);
            const userWinsData = [];
            const userLossesData = [];
            const drawsData = [];

            let cumulativeWins = 0;
            let cumulativeLosses = 0;
            let cumulativeDraws = 0;

            // Calculate cumulative values for displayed range
            const startIndex = Math.max(0, gameState.history.length - 10);
            if (startIndex > 0) {
                for (let i = 0; i < startIndex; i++) {
                    const result = gameState.history[i].result;
                    if (result === 'USER_WIN') cumulativeWins++;
                    else if (result === 'AI_WIN') cumulativeLosses++;
                    else cumulativeDraws++;
                }
            }

            recentHistory.forEach(round => {
                if (round.result === 'USER_WIN') cumulativeWins++;
                else if (round.result === 'AI_WIN') cumulativeLosses++;
                else cumulativeDraws++;

                userWinsData.push(cumulativeWins);
                userLossesData.push(cumulativeLosses);
                drawsData.push(cumulativeDraws);
            });

            chart.data.labels = labels;
            chart.data.datasets[0].data = userWinsData;
            chart.data.datasets[1].data = userLossesData;
            chart.data.datasets[2].data = drawsData;
            chart.update();
        }

        function showGameEndModal() {
            const modal = document.getElementById('gameEndModal');
            const title = document.getElementById('modalTitle');
            const message = document.getElementById('modalMessage');

            if (gameState.userWins >= 30) {
                title.textContent = '„ÅÇ„Å™„Åü„ÅÆÂãùÂà©ÔºÅ';
                message.textContent = `„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ${gameState.userWins}Âãù ${gameState.aiWins}Êïó ${gameState.draws}Âºï„ÅçÂàÜ„Åë„Åß„Åó„Åü„ÄÇ`;
            } else {
                title.textContent = 'AI„ÅÆÂãùÂà©';
                message.textContent = `ÊÆãÂøµÔºÅAI„ÅåÂãù„Å°„Åæ„Åó„Åü„ÄÇ${gameState.userWins}Âãù ${gameState.aiWins}Êïó ${gameState.draws}Âºï„ÅçÂàÜ„Åë„Åß„Åó„Åü„ÄÇ`;
            }

            modal.classList.add('active');
        }

        function resetGame() {
            gameState = {
                round: 0,
                aiWins: 0,
                userWins: 0,
                draws: 0,
                history: [],
                userHandHistory: [],
                aiHandHistory: [],
                historyDependency: {},
                ngramTable: {},
                nextAIHand: null
            };

            initHistoryDependency();
            updateScores();
            updateHistoryTable();
            updateChart();

            document.querySelectorAll('.hand-button').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('gameEndModal').classList.remove('active');
            document.getElementById('aiAvatar').textContent = 'üòÄ';

            // Prepare first AI hand for new game
            prepareNextAIHand();
        }

        // Keyboard controls
        document.addEventListener('keydown', function(event) {
            // Ignore if game is over
            if (gameState.aiWins >= 30 || gameState.userWins >= 30) return;

            const key = event.key.toLowerCase();

            // 1, 2, 3 keys (position-based)
            if (key === '1') {
                playRound('ROCK');
            } else if (key === '2') {
                playRound('PAPER');
            } else if (key === '3') {
                playRound('SCISSORS');
            }
            // R, P, S keys (hand-based)
            else if (key === 'r') {
                playRound('ROCK');
            } else if (key === 'p') {
                playRound('PAPER');
            } else if (key === 's') {
                playRound('SCISSORS');
            }
        });

        // Initialize on page load
        window.onload = initGame;
    </script>
</body>
</html>
